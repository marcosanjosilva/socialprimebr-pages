<!doctype html><html><head><title>SocialPrimeBR — Perfis</title>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="favicon.svg"/>
  <link rel="stylesheet" href="theme.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient('https://mmfqumjckeumidrbysnf.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZnF1bWpja2V1bWlkcmJ5c25mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyODg2NzAsImV4cCI6MjA3MTg2NDY3MH0.jlbBLPsz4CqsHqTKTUD5o1xtE8kvAok7x4s3VGaYAAA');
    async function requireSession(){ const { data:{ session } } = await supabase.auth.getSession(); if(!session){ location.href='login.html'; return null; } return session; }
    function cap(s){ if(!s) return ""; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
  </script>
  <script src="background.js" defer></script>
</head>
<body>
  <div class="gridbg"></div>
  <header>
    <a class="brand" href="dashboard.html">
      <svg viewBox="0 0 24 24" fill="none"><path d="M5 14L13 2l-2 8h8L9 22l2-8H5z" fill="url(#g)"/><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#6ea8ff"/><stop offset=".7" stop-color="#8e7bff"/></linearGradient></defs></svg>
      SocialPrimeBR
    </a>
    <div style="display:flex;gap:10px">
      <a href="dashboard.html" class="btn secondary">← Voltar ao Dashboard</a>
      <a id="logout" class="btn">Sair</a>
    </div>
  </header>

  <div class="wrap">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h2 style="margin:0">Perfis (workspaces)</h2>
      <button class="btn" id="openNew">+ Criar novo perfil</button>
    </div>
    <div id="list" class="cards"></div>
    <div id="goDashWrap" style="margin-top:16px;display:none"><a class="btn secondary" href="dashboard.html">Ir para o Dashboard</a></div>
  </div>

  <div id="modal" class="modal-bg">
    <div class="modal">
      <h3 style="margin-top:0">Novo perfil</h3>
      <label>Nome do perfil</label><input id="wsName" placeholder="Ex.: Agência — Cliente A"/>
      <div style="margin-top:12px;display:flex;justify-content:flex-end;gap:8px">
        <button class="btn secondary" id="cancel">Cancelar</button>
        <button class="btn" id="create">Criar</button>
      </div>
      <div id="msg" class="muted" style="margin-top:10px"></div>
    </div>
  </div>

  <script>
    document.getElementById('openNew').onclick=()=>document.getElementById('modal').style.display='flex';
    document.getElementById('cancel').onclick=()=>document.getElementById('modal').style.display='none';
    document.getElementById('logout').onclick=async()=>{ await supabase.auth.signOut(); location.href='login.html'; };

    async function load(){
      const s=await requireSession(); if(!s) return;
      const res=await supabase.from('workspaces').select('id,name,created_at').order('created_at');
      const list=document.getElementById('list'); list.innerHTML="";
      document.getElementById('goDashWrap').style.display = (res.data||[]).length? 'block':'none';
      (res.data||[]).forEach(w=>{
        const el=document.createElement('div'); el.className='card span-6';
        el.innerHTML='<div class="ws-mini">'
          +'<div><strong>'+cap(w.name)+'</strong><div class="muted">Criado em '+new Date(w.created_at).toLocaleDateString('pt-BR')+'</div></div>'
          +'<div><button class="btn" onclick="useWS(\\''+w.id+'\\',\\''+w.name+'\\')">Usar</button></div>'
          +'</div>';
        list.appendChild(el);
      });
    }
    async function createWS(){
      const name=(document.getElementById('wsName').value||'').trim(); const msg=document.getElementById('msg');
      if(name.length<2){ msg.textContent='Informe um nome válido.'; return; }
      const ins=await supabase.from('workspaces').insert({name}).select().single();
      if(ins.error){ msg.textContent=ins.error.message; return; }
      localStorage.setItem('sp_active_ws_id',ins.data.id); localStorage.setItem('sp_active_ws_name',ins.data.name);
      location.href='dashboard.html';
    }
    document.getElementById('create').onclick=createWS;
    window.useWS=(id,name)=>{ localStorage.setItem('sp_active_ws_id',id); localStorage.setItem('sp_active_ws_name',name); location.href='dashboard.html'; };
    load();
  </script>
</body></html>
