<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <title>Entrar — SocialPrimeBR</title>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="color-scheme" content="dark light">
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <style>
    :root{ --bg:#0b0f17; --bg-2:#0f1522; --fg:#e6ecff; --muted:#9bb0d6;
           --brand:#6ea8ff; --brand-2:#8e7bff; --border:rgba(255,255,255,.08); --grid:rgba(255,255,255,.06);}
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0; font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;
      background: radial-gradient(1200px 800px at 80% -10%, #14223c 0%, transparent 60%),
                  radial-gradient(1000px 700px at -10% 100%, #1e1240 0%, transparent 60%),
                  linear-gradient(180deg, var(--bg) 0%, var(--bg-2) 100%);
      color:var(--fg); overflow-x:hidden;}
    .grid{position:fixed; inset:0; pointer-events:none; opacity:.35;
      background-image:linear-gradient(var(--grid) 1px, transparent 1px),
                       linear-gradient(90deg, var(--grid) 1px, transparent 1px);
      background-size:46px 46px, 46px 46px; mask-image: radial-gradient(ellipse at 50% 30%, rgba(255,255,255,.9) 0%, rgba(255,255,255,.2) 60%, transparent 100%);
      animation:drift 30s linear infinite; z-index:0;}
    @keyframes drift{from{background-position:0 0,0 0} to{background-position:200px 200px,200px 200px}}
    #fx{position:fixed; inset:0; width:100vw; height:100vh; z-index:0; pointer-events:none;}
    .mouse-glow{position:fixed; inset:0; pointer-events:none; z-index:0;
      background: radial-gradient(240px 240px at var(--mx,50%) var(--my,50%), rgba(38,144,255,.25), transparent 70%),
                  radial-gradient(480px 480px at calc(var(--mx,50%) + 8%) calc(var(--my,50%) + 12%), rgba(142,123,255,.18), transparent 70%);}
    .wrap{position:relative; z-index:1; min-height:100%; display:grid; place-items:center; padding:40px 18px;}
    .card{width:min(960px,95vw); border:1px solid var(--border); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      backdrop-filter: blur(8px); border-radius:20px; padding:32px; box-shadow:0 10px 40px rgba(0,0,0,.45); margin:40px auto;}
    .back{display:inline-block; margin-bottom:10px; text-decoration:none; color:#cfe0ff; border:1px solid var(--border); padding:10px 14px; border-radius:10px; background:rgba(110,168,255,.12)}
    h1{font-size:clamp(32px,5vw,56px); margin:6px 0 12px}
    p, li{line-height:1.7; font-size:16px; opacity:.92}
    .muted{color:var(--muted)}
    .badge{display:inline-flex; align-items:center; gap:10px; padding:8px 12px; border-radius:999px; background:rgba(110,168,255,.12);
      border:1px solid rgba(110,168,255,.25); color:#cfe0ff; font-weight:600; font-size:.9rem;}
    .cta{display:flex; flex-wrap:wrap; gap:12px; margin-top:18px}
    .btn{appearance:none; border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(110,168,255,.18), rgba(110,168,255,.06)); color:#eaf2ff; padding:12px 16px; border-radius:12px;
      font-weight:600; font-size:15px; cursor:pointer; transition:transform .08s ease, border-color .2s ease; text-decoration:none; display:inline-flex; gap:10px;}
    .btn:hover{ transform: translateY(-1px); border-color: rgba(110,168,255,.5) }
    .btn.secondary{ background:linear-gradient(180deg, rgba(142,123,255,.18), rgba(142,123,255,.06)); }
    .links{margin-top:20px} .links a{color:#cfe0ff; text-decoration:none; margin-right:16px}
    footer{margin-top:22px; color:#8ea3c6; font-size:14px}
    .highlight{background:linear-gradient(90deg, var(--brand), var(--brand-2)); -webkit-background-clip:text; background-clip:text; color:transparent; font-weight:800; position:relative;}
    .highlight::after{content:''; position:absolute; left:0; right:0; bottom:-2px; height:2px; background:linear-gradient(90deg, rgba(110,168,255,.7), rgba(142,123,255,.7)); filter:blur(1px); animation:sweep 2.4s ease-in-out infinite;}
    @keyframes sweep{0%{transform:translateX(-10%);opacity:.6}50%{transform:translateX(10%);opacity:1}100%{transform:translateX(-10%);opacity:.6}}
    form{display:grid; gap:14px; margin-top:12px} label{font-weight:600} input, textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--border); background: rgba(255,255,255,.04); color:var(--fg);}
    small{color:#9bb0d6}
    .error{ color:#ff9aa2; } .ok{ color:#9be79b; }
  </style>

</head>
<body>
  <canvas id="fx" aria-hidden="true"></canvas>
  <div class="mouse-glow" aria-hidden="true"></div>
  <div class="grid" aria-hidden="true"></div>

  <main class="wrap">
    <section class="card" role="region" aria-label="Login">
      <a class="back" href="index.html">← Voltar</a>
      <h1>Entrar</h1>
      <form id="loginForm" novalidate>
        <label for="ident">E-mail ou CPF/CNPJ</label>
        <input id="ident" type="text" placeholder="voce@exemplo.com ou 00.000.000/0000-00" required>
        <small id="loginIdentHint" class="error"></small>

        <label for="senha">Senha</label>
        <input id="senha" type="password" placeholder="Sua senha" required>
        <div class="cta">
          <button class="btn" type="submit">Entrar</button>
          <a class="btn" href="cadastro.html" role="button">Criar conta</a>
        </div>
        <div style="margin-top:8px">
          <a href="recuperar.html">Esqueceu a senha?</a>
        </div>
      </form>
    </section>
  </main>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
    const supabase = createClient('https://mmfqumjckeumidrbysnf.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZnF1bWpja2V1bWlkcmJ5c25mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyODg2NzAsImV4cCI6MjA3MTg2NDY3MH0.jlbBLPsz4CqsHqTKTUD5o1xtE8kvAok7x4s3VGaYAAA');

    function soDigitos(v){ return (v||'').replace(/\D+/g,''); }
    function mascaraCpfCnpj(input){
      let v = soDigitos(input.value).slice(0,14);
      if(v.length <= 11){
        v = v.replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      } else {
        v = v.replace(/(\d{2}})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1.$2').replace(/(\d{3})(\d)/, '$1/$2').replace(/(\d{4})(\d{1,2})$/, '$1-$2');
      }
      input.value = v;
    }
    function emailValido(v){ v=(v||'').replace(/\s+/g,'').toLowerCase(); return /^[a-z0-9.!#$%&'*+\/=?^_`{|}~-]+@[a-z0-9-]+(?:\.[a-z0-9-]+)+$/.test(v); }
    function validaCPF(cpf){
      cpf = soDigitos(cpf);
      if(cpf.length !== 11 || /^([0-9])\1+$/.test(cpf)) return false;
      let soma=0; for(let i=0;i<9;i++) soma += parseInt(cpf.charAt(i))*(10-i);
      let d1 = 11 - (soma % 11); if(d1>9) d1=0; if(d1 != parseInt(cpf.charAt(9))) return false;
      soma=0; for(let i=0;i<10;i++) soma += parseInt(cpf.charAt(i))*(11-i);
      let d2 = 11 - (soma % 11); if(d2>9) d2=0; return d2 == parseInt(cpf.charAt(10));
    }
    function validaCNPJ(cnpj){
      cnpj = soDigitos(cnpj);
      if(cnpj.length !== 14 || /^([0-9])\1+$/.test(cnpj)) return false;
      const peso1=[5,4,3,2,9,8,7,6,5,4,3,2], peso2=[6,5,4,3,2,9,8,7,6,5,4,3,2];
      let soma=0; for(let i=0;i<12;i++) soma += parseInt(cnpj.charAt(i))*peso1[i];
      let d1 = soma % 11; d1 = d1 < 2 ? 0 : 11 - d1; if(d1 != parseInt(cnpj.charAt(12))) return false;
      soma=0; for(let i=0;i<13;i++) soma += parseInt(cnpj.charAt(i))*peso2[i];
      let d2 = soma % 11; d2 = d2 < 2 ? 0 : 11 - d2; return d2 == parseInt(cnpj.charAt(13));
    }
    function ehCpfOuCnpjValido(v){ const d=soDigitos(v); if(d.length===11) return validaCPF(d); if(d.length===14) return validaCNPJ(d); return false; }

    const ident = document.getElementById('ident');
    const hint = document.getElementById('loginIdentHint');

    ident.addEventListener('input', () => {
      const val = ident.value;
      if(/[A-Za-z@]/.test(val)) {
        if(val.includes('@')){
          const ok = emailValido(val);
          ident.setCustomValidity(ok ? '' : 'E-mail com formato inválido.');
          hint.textContent = ok ? '' : 'Informe um e-mail válido (ex.: nome@dominio.com).';
        } else {
          ident.setCustomValidity('');
          hint.textContent = '';
        }
        return;
      }
      ident.value = soDigitos(val).slice(0,14);
      mascaraCpfCnpj(ident);
      ident.setCustomValidity('');
      hint.textContent='';
    });

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = document.getElementById('senha').value;
      let identifier = ident.value.trim();
      let email = null;

      if(identifier.includes('@')) {
        if(!emailValido(identifier)) { hint.textContent='Informe um e-mail válido.'; return; }
        email = identifier.replace(/\s+/g,'').toLowerCase();
      } else {
        const doc = soDigitos(identifier);
        if(!ehCpfOuCnpjValido(doc)) { hint.textContent='CPF/CNPJ inválido.'; return; }
        const { data: rpcData, error: rpcErr } = await supabase.rpc('get_email_by_doc', { p_doc: doc });
        if(rpcErr || !rpcData) { hint.textContent='Documento não encontrado.'; return; }
        email = rpcData;
      }

      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if(error) { alert('Erro ao entrar: ' + error.message); return; }
      location.href = 'dashboard.html';
    });
  </script>

  <script>
    addEventListener('DOMContentLoaded', ()=>{
      const c = document.getElementById('fx'); if(!c) return;
      const ctx = c.getContext('2d', {alpha:true});
      let dpr=1,w=0,h=0,parts=[]; let animId=0;
      const cfg={count:90,maxSpeed:.32,radius:2,linkDist:120};
      function resize(){ dpr=Math.max(1, Math.min(devicePixelRatio||1,2)); w=c.width=Math.floor(innerWidth*dpr); h=c.height=Math.floor(innerHeight*dpr); c.style.width='100vw'; c.style.height='100vh'; }
      function rand(a,b){return a+Math.random()*(b-a)}
      function init(){ parts=Array.from({length:cfg.count},()=>({x:rand(0,w),y:rand(0,h),vx:rand(-cfg.maxSpeed,cfg.maxSpeed),vy:rand(-cfg.maxSpeed,cfg.maxSpeed)})); }
      function step(){ ctx.clearRect(0,0,w,h);
        for(let i=0;i<parts.length;i++){ const p=parts[i]; p.x+=p.vx; p.y+=p.vy; if(p.x<0||p.x>w) p.vx*=-1; if(p.y<0||p.y>h) p.vy*=-1;
          for(let j=i+1;j<parts.length;j++){ const q=parts[j], dx=p.x-q.x, dy=p.y-q.y, dist=Math.hypot(dx,dy);
            if(dist<cfg.linkDist*dpr){ const a=1-dist/(cfg.linkDist*dpr); ctx.strokeStyle='rgba(110,168,255,'+(0.25*a)+')'; ctx.lineWidth=1*dpr; ctx.beginPath(); ctx.moveTo(p.x,p.y); ctx.lineTo(q.x,q.y); ctx.stroke(); }
          }
          ctx.fillStyle='rgba(142,123,255,.9)'; ctx.beginPath(); ctx.arc(p.x,p.y,cfg.radius*dpr,0,Math.PI*2); ctx.fill();
        }
        animId=requestAnimationFrame(step);
      }
      function start(){ cancelAnimationFrame(animId); resize(); init(); step(); }
      addEventListener('resize', start); addEventListener('scroll', ()=>{ if(!animId) start(); });
      addEventListener('mousemove', (e)=>{ document.documentElement.style.setProperty('--mx', e.clientX+'px'); document.documentElement.style.setProperty('--my', e.clientY+'px'); });
      start();
    });
  </script>

</body>
</html>
