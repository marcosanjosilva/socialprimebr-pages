<!doctype html><html><head><title>SocialPrimeBR — Agendar</title>
  <meta charset="utf-8"/><meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="favicon.svg"/>
  <link rel="stylesheet" href="theme.css"/>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const supabase = window.supabase.createClient('https://mmfqumjckeumidrbysnf.supabase.co','eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1tZnF1bWpja2V1bWlkcmJ5c25mIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyODg2NzAsImV4cCI6MjA3MTg2NDY3MH0.jlbBLPsz4CqsHqTKTUD5o1xtE8kvAok7x4s3VGaYAAA');
    async function requireSession(){ const { data:{ session } } = await supabase.auth.getSession(); if(!session){ location.href='login.html'; return null; } return session; }
    function cap(s){ if(!s) return ""; return s.charAt(0).toUpperCase()+s.slice(1).toLowerCase(); }
  </script>
  <script src="background.js" defer></script>
</head>
<body>
  <div class="gridbg"></div>
  <header>
    <a class="brand" href="dashboard.html">
      <svg viewBox="0 0 24 24" fill="none"><path d="M5 14L13 2l-2 8h8L9 22l2-8H5z" fill="url(#g)"/><defs><linearGradient id="g" x1="0" y1="0" x2="1" y2="1"><stop stop-color="#6ea8ff"/><stop offset=".7" stop-color="#8e7bff"/></linearGradient></defs></svg>
      SocialPrimeBR
    </a>
    <div style="display:flex;gap:10px">
      <a href="dashboard.html" class="btn secondary">← Voltar ao Dashboard</a>
      <a href="calendar.html" class="btn secondary">Calendário</a>
      <a href="settings.html" class="btn secondary">Configurações</a>
      <a id="logout" class="btn">Sair</a>
    </div>
  </header>

  <div class="wrap">
    <h2 style="margin:0 0 6px">Agendar publicação</h2>
    <div class="cards">
      <div class="card span-6">
        <h3>Conteúdo</h3>
        <label>Texto</label><textarea id="caption" style="width:100%;min-height:120px;border-radius:12px;border:1px solid var(--b1);background:rgba(255,255,255,.04);color:var(--fg);padding:10px"></textarea>
        <label>Mídia (opcional)</label><input type="file" id="media" multiple/>
      </div>
      <div class="card span-6">
        <h3>Quando & onde</h3>
        <label>Data</label><input type="date" id="date"/>
        <label>Hora</label><input type="time" id="time"/>
        <label>Redes</label>
        <div class="muted">Seleção será ligada às permissões do perfil futuramente.</div>
        <div style="margin-top:12px"><button class="btn" id="save">Agendar</button></div>
        <div id="msg" class="muted" style="margin-top:8px"></div>
      </div>
      <div class="card span-12">
        <h3>Agendamentos</h3>
        <div class="muted">Lista aparecerá aqui quando integrarmos a tabela de agendamentos.</div>
      </div>
    </div>
  </div>

  <aside id="gpt" class="sidegpt">
    <header><strong>Assistente</strong></header>
    <div class="chatui"><div id="msgs" class="msgs"></div>
      <form id="chatForm"><input id="chatInput" placeholder="Pergunte algo…"/><button class="btn">Enviar</button></form>
    </div>
  </aside>

  <script>
    document.getElementById('logout').onclick=async()=>{ await supabase.auth.signOut(); location.href='login.html'; };
    document.getElementById('save').onclick=()=>{ document.getElementById('msg').textContent='Protótipo: salvaremos quando criarmos a tabela de agendamentos.'; };
    requireSession();
  </script>

<script>
const FN_URL = 'https://mmfqumjckeumidrbysnf.supabase.co/functions/v1/sp_assistant';
let history = [{role:'system', content:'Você é o assistente da SocialPrimeBR.'}];
function ensureSide(){
  const panel=document.getElementById('gpt'); if(!panel) return;
  if(innerWidth>=1200) panel.style.display='block';
}
addEventListener('resize', ensureSide);
function pushMsg(role, text){
  const msgs=document.getElementById('msgs'); const el=document.createElement('div');
  el.className='msg '+role; el.innerHTML='<div class="bubble">'+(text||'').replace(/</g,'&lt;')+'</div>';
  msgs.appendChild(el); msgs.scrollTop=msgs.scrollHeight;
}
document.addEventListener('DOMContentLoaded', ()=>{
  ensureSide();
  const form=document.getElementById('chatForm'); if(!form) return;
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const inp=document.getElementById('chatInput');
    const text=(inp.value||'').trim(); if(!text) return;
    inp.value=''; pushMsg('user', text);
    try{
      const { data:{ session } } = await supabase.auth.getSession();
      const r = await fetch(FN_URL, {
        method:'POST', headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+session.access_token },
        body: JSON.stringify({ messages: history.concat([{role:'user', content:text}]) })
      });
      const j = await r.json();
      const reply=((j.choices&&j.choices[0]&&j.choices[0].message&&j.choices[0].message.content)||j.content||j.text||'Sem resposta');
      pushMsg('assistant', reply);
      history.push({role:'user', content:text}); history.push({role:'assistant', content:reply});
    }catch(e){ pushMsg('assistant',"Erro ao falar com o assistente."); }
  });
});
</script>

</body></html>
